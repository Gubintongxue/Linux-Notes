## 24.1 编译前的任务：认识核心与取得核心源代码

在第一章中，我们谈到过 Linux 实际上指的是核心。这个“核心（kernel）”是操作系统的最底层，负责整个硬件的驱动，并提供系统所需的核心功能，如防火墙机制、文件系统支持等。因此，核心的作用至关重要。以下是核心的一些基本概念和相关知识。

### 24.1.1 什么是核心（Kernel）

#### 核心的作用

核心负责控制计算机硬件，执行系统所需的各项功能。如果核心不支持某个硬件或功能，那么该硬件或功能在系统中将无法使用。例如，如果核心没有包含某个网络功能的支持，不论如何设置，该功能都无法使用。因此，核心在操作系统中起着至关重要的作用。

#### 核心模块（Kernel Module）

为了应对硬件更新速度快的情况，Linux 采用了模块化设置。一些不常用的驱动程序被独立出来，编译成模块，系统运行时可以动态加载这些模块，无需重新编译整个核心。核心模块存放在 `/lib/modules/$(uname -r)/kernel/` 目录下。

#### 核心编译

核心是通过源代码编译而成的。源代码可以通过编译生成系统可识别的核心文件。编译核心可以使系统支持新的硬件或功能，同时也可以优化系统性能和稳定性。

### 24.1.2 更新核心的目的

核心是操作系统中最早被加载到内存的部分，包含所有硬件和软件工作所需的信息。因此，更新核心的主要目的是让系统支持新的硬件或功能，提升系统稳定性和性能。

编译核心的可能原因包括：

- **新功能需求**：例如，需要新的核心版本才能支持某些新功能。
- **原本核心太臃肿**：去除不需要的功能，使核心更简洁高效。
- **与硬件搭配的稳定性**：针对特定硬件进行优化。
- **嵌入式系统**：为特定用途的系统定制核心。

### 24.1.3 核心的版本

CentOS 7 使用 3.10.x 版本的长期维护核心。虽然理论上可以升级到更新的主线版本，但通常建议使用长期维护版本的最新版本。例如，CentOS 7 使用的是 3.10.0 版本，最新的长期维护版本是 3.10.89。

### 24.1.4 核心源代码的取得方式

核心源代码可以通过以下几种方式获取：

#### 1. 使用 Distribution 提供的核心源代码文件

大多数主流 distributions 都提供了核心源代码。CentOS 的源代码可以从以下网址获取：

- [全部的 CentOS 原始 SRPM](http://vault.centos.org/)
- [CentOS 7.1 的 SRPM](http://vault.centos.org/7.1.1503/)

使用 distribution 提供的源代码的好处是可以了解默认的核心设置参数，便于修改和定制。

#### 2. 获取最新的稳定版核心源代码

最新的核心源代码可以从 kernel 官方网站下载：

- [核心官网](http://www.kernel.org/)
- [交大资科]()
- [国高中心]()

#### 3. 利用 patch 升级核心源代码

每次核心更新时，会发布与前一版本的差异性 patch 文件。可以通过 patch 文件升级核心源代码。需要依序应用 patch 文件，例如从 3.10.85 升级到 3.10.89，需要下载并依次应用 patch-3.10.86, patch-3.10.87, patch-3.10.88 和 patch-3.10.89。

### 24.1.5 核心源代码的解压缩/安装/观察

核心源代码通常下载为一个 tarball 文件。以下是解压缩和安装的步骤：

#### 解压缩核心源代码

假设下载的核心源代码文件为 `linux-3.10.89.tar.xz`，放置在 `/root` 目录下。解压缩并放置在 `/usr/src/kernels/` 目录下：

```
bash
复制代码
[root@study ~]# tar -Jxvf linux-3.10.89.tar.xz -C /usr/src/kernels/
```

解压后，会在 `/usr/src/kernels` 目录下生成 `linux-3.10.89` 目录。编译和设置核心都将在这个目录下进行。

#### 核心源代码目录结构

核心源代码目录下包含以下重要数据：

- `arch`：与硬件平台有关的设置，主要是 CPU 类型。
- `block`：与区块设备相关的设置。
- `crypto`：核心支持的加密技术。
- `Documentation`：核心相关的文档。
- `drivers`：硬件驱动程序。
- `firmware`：旧式硬件的固件数据。
- `fs`：核心支持的文件系统。
- `include`：其他程序调用的头文件定义。
- `init`：核心初始化定义功能。
- `ipc`：定义系统内各程序的通信。
- `kernel`：定义核心程序、状态、线程、调度、信号等。
- `lib`：一些函数库。
- `mm`：与内存单元相关的数据。
- `net`：与网络协议相关的数据。
- `security`：包括 selinux 等安全设置。
- `sound`：与音效相关的模块。
- `virt`：与虚拟化机器相关的信息。

这些目录和文件提供了核心编译和定制的基础信息。在进行核心编译和设置时，可以参考这些目录下的内容。